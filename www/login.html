<!DOCTYPE HTML>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta http-equiv="Content-Security-Policy" content="default-src * data: gap: content: https://ssl.gstatic.com; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'">
  <script src="components/loader.js"></script>
  <script src="css/jquery-3.6.0.min.js"></script>
  <script src="css/jquery.qrcode.min.js"></script>
  <script type="text/javascript" src="css/login.js"></script>
  <link rel="stylesheet" href="components/loader.css">
  <link href="https://fonts.googleapis.com/css?family=Oswald:700 rel=" stylesheet ">
  <link rel="stylesheet " href="css/login.css ">
  

<link href="https://fonts.googleapis.com/css?family=Montserrat+Subrayada rel="stylesheet">

  <link href="https://use.fontawesome.com/releases/v5.6.1/css/all.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script>
    // APIキーの設定とSDK初期化
    // API key.
    var applicationKey = "4d9d122337ca0de373857821e96b10ad1952a9133ffea44e66bcee94c282fccf";
    var clientKey = "00902e576a265322a217a2b2706056ca26048d4bd4f9096744fdd7e565d0f377";
    // SDK initialization.
    var ncmb = new NCMB(applicationKey, clientKey);

    //新規ユーザ作成
    function createNewUser() {
      var createN = document.getElementById("cN").value;
      var createP = document.getElementById("cP").value;
      var createSN = document.getElementById("cSN").value;
      // ユーザークラスのインスタンスを生成
      var user = new ncmb.User();
      //ユーザ名/パスワードで新規ユーザー登録
      user.set("user_account_name", createN)
        .set("userName", createSN)
        .set("password", createP)
        .set("acl", (new ncmb.Acl()).setPublicWriteAccess(true).setPublicReadAccess(true))
        .signUpByAccount()
        .then(function(newUser) {
          //新規ユーザー登録成功
          console.log("新規ユーザー登録成功：" + JSON.stringify(newUser));
          const userAcl = new ncmb.Acl();
          userAcl.setPublicReadAccess(true)
            .setUserWriteAccess(newUser, true)
            .setUserReadAccess(newUser, true);
          return newUser.set("acl", userAcl).update();
        })
        .then(function(user) {
          // アクセスコントロール更新成功時の処理
          console.log("更新成功:" + JSON.stringify(user));
          return ncmb.User.login(user);
        })
        .then(function(user) {
          location.href = "./index.html";
        })
        .catch(function(error) {
          //新規ユーザー登録失敗時の処理
          console.log("新規ユーザー登録・更新失敗：" + JSON.stringify(error));
        });
    }

    //ログイン機能
    function wineLogin() {

      var loginStudentNumber = document.getElementById("lSN").value;
      var loginPassword = document.getElementById("loginPass").value;
      ncmb.User.login(loginStudentNumber, loginPassword)
        .then(function(user) {
          //ログイン成功時の処理(例)
          //console.log("ログイン成功：" + JSON.stringify(user));
          console.log("ログイン成功：" + ncmb.User.getCurrentUser());
          document.location.href = 'index.html';
        })
        .catch(function(error) {
          //ログイン失敗時の処理
          console.log("ログイン失敗：" + JSON.stringify(error));
        });



    }

    //検索機能
    function wineSearch() {
      var loginStudentNumber = document.getElementById("searchSN").value;
      let lowNumber = 0;
      ncmb.User.fetchAll()
        .then(users => {
          users.forEach(user => {
            console.log(user);
            //ここで登録されている学籍番号かチェック
            if (user.userName === loginStudentNumber) {
              console.log("あった！");
              console.log(user.user_account_name);
              lowNumber = lowNumber + 1;
            }
          })
          console.log("検索結果：" + lowNumber + "件");
        }).catch(err => {
          console.log("変数データ取得エラー")
        });

      
    }

    //ログイン中ユーザ確認
    function confarm() {
      // カレントユーザー情報の取得
      alert("確認")
      var currentUser = ncmb.User.getCurrentUser();
      if (currentUser) {
        console.log("ログイン中のユーザー: " + currentUser.get("userName"));
      } else {
        console.log("未ログインまたは取得に失敗");
      }

    }
  </script>
</head>

<body id="welcom">
  <div id="form">
    <div class="form-title">
      <p class="form-title">ワインの窓</p>
      <p class="subTitle" id="subTitle">_Wine Window_</p>
    </div>
    <div id="wine">
      <img src="img/wineWindow.png" id="wineWindow">
    </div>
    <div class="form">
      <div class="wrap-tab">
        <ul id="js-tab" class="list-tab">
          <li class="active">新規作成</li>
          <li>ログイン</li>
        </ul>

        <div class="wrap-tab-content">
          <!--新規作成-->
          <div class="tab-content active">
            <input type="text" id="cN" placeholder="name" name="createName" />
            <input type="password" id="cP" placeholder="password" name="createPass" />
            <input type="text" placeholder="studentNumber" id="cSN" idname="createStudentNumber" />
            <div class="bt-wine">
              <a href="javascript:createNewUser();" class="bt-samp37">CREATE</a>
            </div>
          </div>

          <!--ログイン-->
          <div class="tab-content">
            <p class="text">
              <input type="number" id="lSN" name="student_number" placeholder="StudentNumber" /></p>

            <p class="pass">
              <input type="password" id="loginPass" name="pass" placeholder="Password" /></p>
            <div class="bt-wine">
              <a href="javascript:wineLogin();" class="bt-samp37">SIGN-IN</a>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!--お試しタブエンド-->
    <input type="text" id="searchSN" />
    <a href="javascript:wineSearch();">検索</a><br>
    <a href="javascript:confarm();">ログインアカウント確認</a>
  </div>
  </div>

  </div>

</body>

</html>