<!DOCTYPE HTML>
<html>

<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta http-equiv="Content-Security-Policy" content="default-src * data: gap: content: https://ssl.gstatic.com; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'">
<script src="components/loader.js"></script>
<link rel="stylesheet" href="components/loader.css">
<link rel="stylesheet" href="css/style.css">
<link rel="stylesheet" href="css/modal.css">
<link rel="stylesheet" href="css/insert.css">
<link rel="stylesheet" href="css/loading.css">
<link href="https://use.fontawesome.com/releases/v5.6.1/css/all.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Roboto:400,100,300,500,700,900" rel="stylesheet">
<script type="text/javascript" src="css/main.js">
</script>
<script type="text/javascript" src="css/"></script>
</script>
<script>
  // APIキーの設定とSDK初期化
  // API key.
  var applicationKey = "4d9d122337ca0de373857821e96b10ad1952a9133ffea44e66bcee94c282fccf";
  var clientKey = "00902e576a265322a217a2b2706056ca26048d4bd4f9096744fdd7e565d0f377";
  // SDK initialization.
  var ncmb = new NCMB(applicationKey, clientKey);

    const wait = (sec) => { // タイマ
      return new Promise((resolve, reject) => {
        setTimeout(resolve, sec*1000);
        //setTimeout(() => {reject(new Error("エラー！"))}, sec*1000);
      });
    };

    async function transition() {
      try {
        document.getElementById('loader-wrap').style.visibility = 'visible';
        await wait(3); // ここで処理待ち
        localStorage.setItem("flag","give");
        document.location.href='insertFixed.html';
      } catch (err) {
        console.error(err);
      }
    }

    function newDeal(){
        
      // 画像ファイル生成
      var imageData = document.getElementById("previewImage");
      var src = previewImage.getAttribute('src');
      var item_image = imgUpload(src);// 先行して画像をアップロード。画像の名前を返す

      var category = document.getElementById("category").value;
      var delivery_end_date = document.getElementById("delivery_end_date").value;
      var delivery_start_date = document.getElementById("delivery_start_date").value;
      var delivery_time = document.getElementById("delivery_time").value;

      var item_info = document.getElementById("item_info").value;
      var item_name = document.getElementById("item_name").value;
      var item_status = document.getElementById("item_status").value;
      var location = document.getElementById("location").value;
      // 
      var Give = ncmb.DataStore("give");
      // クラスインスタンスの生成
      var give = new Give();
      // データを設定して保存する
      give.set("category", category)
        .set("deal_status", "成立待ち")
        .set("delivery_end_date", delivery_end_date)
        .set("delivery_start_date", delivery_start_date)
        .set("delivery_time", delivery_time)
        .set("item_image", item_image)
        .set("item_info", item_info)
        .set("item_name", item_name)
        .set("item_status", item_status)
        .set("location", location)
        .save();
        transition();
      }

    // 画像アップロード用スクリプト
    function imgUpload(imageData) {
      // ncmbに画像をアップロード
      var fileName = makeUUID() + ".jpg";
      var fileData = toBlob(imageData, "image/jpeg");
      ncmb.File.upload(fileName, fileData);
      return fileName;
    }

    // Blob作成
    function toBlob(base64, mime_type) {
      var bin = atob(base64.replace(/^.*,/, ''));
      var buffer = new Uint8Array(bin.length);
      for (var i = 0; i < bin.length; i++) {
        buffer[i] = bin.charCodeAt(i);
      }

      try {
        var blob = new Blob([buffer.buffer], {
          type: mime_type
        });
      } catch (e) {
        return false;
      }
      return blob;
    }

    //UUID生成
    function makeUUID() {
      var d = +new Date();
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'
        .replace(/[xy]/g, function(c) {
          var r = (d + Math.random() * 16) % 16 | 0;
          return (c == 'X' ? r : (r & 0x3 | 0x8)).toString(16);

        });
    }
    </script>
    <script>
    // 値を書き換える
    function changeDtime(){
      var delivery_time = document.getElementById("delivery_time").value;
      switch (delivery_time){
            case '1':
              delivery_time = "１コマ目終了後";
              break;
            case '2':
              delivery_time = "昼休み";
              break;
            case '3':
              delivery_time = "３コマ目終了後";
              break;
            case '4':
              delivery_time = "４コマ目終了後";
              break;
            default:
              break;
          }
      return delivery_time;
    }

    function changeLocation(){
      var location = document.getElementById("location").value;
      switch (location){
            case '1':
              location = "本校舎3Fホール";
              break;
            case '2':
              location = "本校舎4Fホール";
              break;
            case '3':
              location = "本校舎5F";
              break;
            case '4':
              location = "本校舎6Fホール";
              break;
            case '5':
              location = "本校舎7F";
              break;
            case '6':
              location = "本校舎8F";
              break;
            case '7':
              location = "2号館入口";
              break;
            case '8':
              location = "3号館入口";
              break;
            case '9':
              location = "3号館ホール";
              break;
            case '100':
              location = "その他";
              break;
            default:
              break;
          }
      return location;
    }
    </script>
    <script>
      // モーダル表示用スクリプト
      function modal_open(){
        const open = document.getElementById('d_open');
        const ok = document.getElementById('d_ok');
        const close = document.getElementById('d_cancel');
        const modal = document.getElementById('d_modal');
        const mask = document.getElementById('mask');
        
        open.addEventListener('click',()=>{
          // 値を置き換える関数を呼ぶ
          var delivery_time = changeDtime();
          var location = changeLocation();
          
          // モーダルの値を書き換える
          document.getElementById('m_item_name').innerHTML = document.getElementById("item_name").value;
          document.getElementById('m_delivery_date').innerHTML = document.getElementById("delivery_start_date").value + "<br>～<br>" + document.getElementById("delivery_end_date").value;
          document.getElementById('m_delivery_time').innerHTML = delivery_time;
          document.getElementById('m_location').innerHTML = location;
          // 表示
          modal.classList.remove('hidden');
          mask.classList.remove('hidden');
        });
        
        close.addEventListener('click',()=>{
          modal.classList.add('hidden');
          mask.classList.add('hidden');
        });
        
        mask.addEventListener('click',()=>{
          close.click();
        });
      }
    </script>
</head>

<body id="prodact_lists">
  <!-- Header Start -->
  <header class="site-header">
    <div class="wrapper site-header__wrapper">
      <nav class="nav">
        <div class="detail_head">
          <div class="back_button">
            <a href="javascript:history.back()">
              <i class="fas fa-angle-left back_size"></i>
            </a>
          </div>
          <div class="page_title">
            <input class="hidden" type="checkbox" id="menu-btn-check"><span class="center">商品情報の入力</span>
            <label for="menu-btn-check" class="menu-btn"><span></span></label>
            <div style="text-align: left" class="menu-content">
              <ul>
                <li><a href="acount.html">アカウント詳細</a></li>
                <li><a href="message.html">通知</a></li>
                <li><a href="dealHistory.html">取引履歴</a></li>
                <li><a href="myGiveItem.html">出品した譲渡品</a></li>
                <li><a href="myTradeItem.html">出品した交換品</a></li>
                <li><a href="javascript:logout();">ログアウト</a></li>
              </ul>
            </div>
          </div>
          <div class="header_right">
          </div>
        </div>
      </nav>
    </div>
  </header>
  <!-- Header End -->
  <div class="right">
    <button type="button" class="newDeal-btn" name="item_image" id="d_open" onclick="modal_open()"> 出品する！ </button>
  </div>
  <div id="mask" class="hidden"></div><br><br><br>

  <!-- 商品画像選択 -->
  <div class="flex" id="newDeal_info" name="item_image">
    <!-- カメラからアップロード -->
    <button class="btn-flat-border">
        📷<input type="file" id="item_image" onChange="imgPreView(event)"/>
        </button>

    <!-- アルバムからアップロード -->
    <form>
      <button class="btn-flat-border">
            📚<input type="file" id="item_image" accept="image/*" multiple=" multiple" onchange="imgPreView(event)">

            </button>
    </form>
  </div>
  <!-- 👇ここにプレビュー画像を追加する -->
  <div class="flex" id="preview" width="300" height="200">
  </div>


  <div class="gray"><br>
    <!-- カテゴリー -->
    <label for="category" class="leftmrg30px">カテゴリー</label>
    <div class="flex" id="newDeal_info">
      <select id="category" name="category" size=1 class="nd_size">
                <option value="1">おもちゃ・ゲーム</option>
                <option value="2">本・テキスト</option>
                <option value="3">音楽・ＤＶＤ</option>
                <option value="4">服・コスメ</option>
                <option value="5">キッチン</option>
                <option value="6">スポーツ</option>
                <option value="7">PC・スマホ用品</option>
                <option value="100">その他</option>
            </select>
    </div><br>

    <!-- 商品の状態 -->
    <label for="item_status" class="leftmrg30px">商品の状態</label>
    <div class="flex" id="newDeal_info">
      <select id="item_status" name="item_status" size="1" class="nd_size">
                <option value="1">新品</option>
                <option value="2">ほぼ新品</option>
                <option value="3">多少の傷あり</option>
                <option value="4">傷・汚れあり</option>
                <option value="5">状態が悪い</option>
            </select>
    </div><br>
  </div><br><br><br>


  <div class="gray"><br>
    <!-- 商品名入力 -->
    <label for="item_name" class="leftmrg30px">商品名</label>
    <div class="flex" id="newDeal_info" name="item_name">
      <input type="text" id="item_name" class="nd_size" name="name" required maxlength="50" size="52">
    </div><br>

    <!-- 商品情報入力 -->
    <label for="item_info" class="leftmrg30px">商品の説明</label>
    <div class="flex" id="newDeal_info" name="item_info">
      <textarea id="item_info" name="item_info" class="width" maxlength="250" rows="8" required></textarea>
    </div><br>
  </div><br><br><br>


  <div class="gray"><br>
    <!-- 受け渡し期間 -->
    <label for="delivery_start_date" class="leftmrg30px">受け渡し期間</label>
    <div class="flex" id="newDeal_info">
      <input type="date" id="delivery_start_date" name="delivery_start_date" class="nd_size_times">
      <p><span class="margin10px">～</span></p>
      <input type="date" id="delivery_end_date" name="delivery_end_date" class="nd_size_times">
    </div>

    <!-- 受け渡し時間帯 -->
    <label for="delivery_time" class="leftmrg30px">受け渡し時間帯</label>
    <div class="flex" id="newDeal_info">
      <select id="delivery_time" name="delivery_time" size="1" class="nd_size">
                <option value="1">１コマ目終了後</option>
                <option value="2">昼休み</option>
                <option value="3">３コマ目終了後</option>
                <option value="4">４コマ目終了後</option>
            </select>
    </div><br>

    <!-- 受け渡し場所 -->
    <label for="location" class="leftmrg30px">受け渡し場所</label>
    <div class="flex" id="newDeal_info">
      <select id="location" name="location" size="1" class="nd_size">
                <option value="1">本校舎3Fホール</option>
                <option value="2">本校舎4Fホール</option>
                <option value="3">本校舎5F</option>
                <option value="4">本校舎6Fホール</option>
                <option value="5">本校舎7F</option>
                <option value="6">本校舎8F</option>
                <option value="7">2号館入口</option>
                <option value="8">3号館入口</option>
                <option value="9">3号館ホール</option>
                <option value="100">その他</option>
            </select>
    </div><br>
  </div><br><br><br>


  <!-- Footer Start -->
  <ul class="bottom-menu">
    <li>
      <a href="index.html">
        <i class="far fa-list-alt"></i></a>
    </li>

    <li>
      <a href="deal.html"><i class="fas fa-random"></i></a>

    </li>
    <li>
      <a class="icon-blue" href="insert.html"><i class="fas fa-plus"></i></a>
    </li>
    <li>
      <a href="qrreader.html"><i class="fas fa-qrcode"></i></a>
    </li>
    <li>
      <a href="voice.html">
        <i class="fas fa-bullhorn"></i></a>
    </li>

</ul>
    <!-- Fotter End -->
    <!-- モーダルウィンドウ -->
      <section id="d_modal" class="hidden">
        <div class="modal_box">
          <a id="m_item_name">商品名</a>
          <br>
          <div class="flex" id="preview" width="300" height="200">
          </div>
          <br>
          <table class="modal_table">
            <tr>
              <th class="modal_table">出品者</th><td id="m_user">値</td>
            </tr>
            <tr>
              <th class="modal_table">受け渡し期間</th><td id="m_delivery_date">値</td>
            </tr>
            <tr>
              <th class="modal_table">受け渡し時間帯</th><td id="m_delivery_time">値</td>
            </tr>
            <tr>
              <th class="modal_table">受け渡し場所</th><td id="m_location">値</td>
            </tr>
          </table>
        </div>
        <br>
        <a>この商品を登録しますか？</a>
        <div id="d_button">
          <div id="d_cancel">
          閉じる
          </div>
          <div id="d_ok" onclick="newDeal()">
          進める
          </div>
        </div>
      </section>
      
      <!--loading animation-->
<div class="loader-wrap" id="loader-wrap">
<div class="bottle-wrap">
<div class="cap"><i></i><i></i><i></i><i></i></div>
<div class="bottle">
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	width="26.81px" height="106.124px" viewBox="0 0.5 26.81 106.124" enable-background="new 0 0.5 26.81 106.124" xml:space="preserve">
	<defs>
	<pattern id="water_fill" width=".25" height="1.1" patternContentUnits="objectBoundingBox">
	<path fill="#8b1b34" d="M0.25,1H0c0,0,0-0.659,0-0.916c0.083-0.303,0.158,0.334,0.25,0C0.25,0.327,0.25,1,0.25,1z"/>
	</pattern>
	<path id="bottle" d="M17.905,38.109V9.734c0,0,1.75-3.125,1.375-5.5s-5.875-2.232-5.875-2.232s-5.5-0.143-5.875,2.232
	s1.375,5.5,1.375,5.5v28.375c0,0-7.405,1.311-7.405,16.03s0,40.72,0,45.47s5.515,5.515,5.515,5.515h6.39h6.39
	c0,0,5.515-0.765,5.515-5.515s0-30.75,0-45.47S17.905,38.109,17.905,38.109z"/>
	<mask id="bottle_mask">
	<use x="0" y="0" xlink:href="#bottle" opacity="0.75" fill="#ffffff"/>
	</mask>
	</defs>
	<rect class="bottle-fill" mask="url(#bottle_mask)" fill="url(#water_fill)" x="-400" y="0" width="1600" height="120"/>
	<path id="btl-out" fill="none" stroke="#000000" stroke-width="3" stroke-miterlimit="10" d="M17.905,38.109V9.734
	c0,0,1.75-3.125,1.375-5.5s-5.875-2.232-5.875-2.232s-5.5-0.143-5.875,2.232s1.375,5.5,1.375,5.5v28.375
	c0,0-7.405,1.311-7.405,16.03s0,40.72,0,45.47s5.515,5.515,5.515,5.515h6.39h6.39c0,0,5.515-0.765,5.515-5.515s0-30.75,0-45.47
	S17.905,38.109,17.905,38.109z"/>
</svg>
</div>
<div class="bottle">
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	width="26.81px" height="106.124px" viewBox="0 0.5 26.81 106.124" enable-background="new 0 0.5 26.81 106.124" xml:space="preserve">
	<defs>
	<pattern id="water_fill" width=".25" height="1.1" patternContentUnits="objectBoundingBox">
	<path fill="#b33e5c" d="M0.25,1H0c0,0,0-0.659,0-0.916c0.083-0.303,0.158,0.334,0.25,0C0.25,0.327,0.25,1,0.25,1z"/>
	</pattern>
	<path id="bottle" d="M17.905,38.109V9.734c0,0,1.75-3.125,1.375-5.5s-5.875-2.232-5.875-2.232s-5.5-0.143-5.875,2.232
	s1.375,5.5,1.375,5.5v28.375c0,0-7.405,1.311-7.405,16.03s0,40.72,0,45.47s5.515,5.515,5.515,5.515h6.39h6.39
	c0,0,5.515-0.765,5.515-5.515s0-30.75,0-45.47S17.905,38.109,17.905,38.109z"/>
	<mask id="bottle_mask">
	<use x="0" y="0" xlink:href="#bottle" opacity="1" fill="#ffffff"/>
	</mask>
	</defs>
	<rect class="bottle-fill" mask="url(#bottle_mask)" fill="url(#water_fill)" x="-400" y="0" width="1600" height="120"/>
	<path id="btl-out" fill="none" stroke="#000000" stroke-width="3" stroke-miterlimit="10" d="M17.905,38.109V9.734
	c0,0,1.75-3.125,1.375-5.5s-5.875-2.232-5.875-2.232s-5.5-0.143-5.875,2.232s1.375,5.5,1.375,5.5v28.375
	c0,0-7.405,1.311-7.405,16.03s0,40.72,0,45.47s5.515,5.515,5.515,5.515h6.39h6.39c0,0,5.515-0.765,5.515-5.515s0-30.75,0-45.47
	S17.905,38.109,17.905,38.109z"/>
</svg>
</div>
<div class="bottle">
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	width="26.81px" height="106.124px" viewBox="0 0.5 26.81 106.124" enable-background="new 0 0.5 26.81 106.124" xml:space="preserve">
	<defs>
	<pattern id="water_fill" width=".25" height="1.1" patternContentUnits="objectBoundingBox">
	<path fill="#b33e5c" d="M0.25,1H0c0,0,0-0.659,0-0.916c0.083-0.303,0.158,0.334,0.25,0C0.25,0.327,0.25,1,0.25,1z"/>
	</pattern>
	<path id="bottle" d="M17.905,38.109V9.734c0,0,1.75-3.125,1.375-5.5s-5.875-2.232-5.875-2.232s-5.5-0.143-5.875,2.232
	s1.375,5.5,1.375,5.5v28.375c0,0-7.405,1.311-7.405,16.03s0,40.72,0,45.47s5.515,5.515,5.515,5.515h6.39h6.39
	c0,0,5.515-0.765,5.515-5.515s0-30.75,0-45.47S17.905,38.109,17.905,38.109z"/>
	<mask id="bottle_mask">
	<use x="0" y="0" xlink:href="#bottle" opacity="1" fill="#ffffff"/>
	</mask>
	</defs>
	<rect class="bottle-fill" mask="url(#bottle_mask)" fill="url(#water_fill)" x="-400" y="0" width="1600" height="120"/>
	<path id="btl-out" fill="none" stroke="#000000" stroke-width="3" stroke-miterlimit="10" d="M17.905,38.109V9.734
	c0,0,1.75-3.125,1.375-5.5s-5.875-2.232-5.875-2.232s-5.5-0.143-5.875,2.232s1.375,5.5,1.375,5.5v28.375
	c0,0-7.405,1.311-7.405,16.03s0,40.72,0,45.47s5.515,5.515,5.515,5.515h6.39h6.39c0,0,5.515-0.765,5.515-5.515s0-30.75,0-45.47
	S17.905,38.109,17.905,38.109z"/>
</svg>
</div>
<div class="bottle">
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	width="26.81px" height="106.124px" viewBox="0 0.5 26.81 106.124" enable-background="new 0 0.5 26.81 106.124" xml:space="preserve">
	<defs>
	<pattern id="water_fill" width=".25" height="1.1" patternContentUnits="objectBoundingBox">
	<path fill="#b33e5c" d="M0.25,1H0c0,0,0-0.659,0-0.916c0.083-0.303,0.158,0.334,0.25,0C0.25,0.327,0.25,1,0.25,1z"/>
	</pattern>
	<path id="bottle" d="M17.905,38.109V9.734c0,0,1.75-3.125,1.375-5.5s-5.875-2.232-5.875-2.232s-5.5-0.143-5.875,2.232
	s1.375,5.5,1.375,5.5v28.375c0,0-7.405,1.311-7.405,16.03s0,40.72,0,45.47s5.515,5.515,5.515,5.515h6.39h6.39
	c0,0,5.515-0.765,5.515-5.515s0-30.75,0-45.47S17.905,38.109,17.905,38.109z"/>
	<mask id="bottle_mask">
	<use x="0" y="0" xlink:href="#bottle" opacity="1" fill="#ffffff"/>
	</mask>
	</defs>
	<rect class="bottle-fill" mask="url(#bottle_mask)" fill="url(#water_fill)" x="-400" y="0" width="1600" height="120"/>
	<path id="btl-out" fill="none" stroke="#000000" stroke-width="3" stroke-miterlimit="10" d="M17.905,38.109V9.734
	c0,0,1.75-3.125,1.375-5.5s-5.875-2.232-5.875-2.232s-5.5-0.143-5.875,2.232s1.375,5.5,1.375,5.5v28.375
	c0,0-7.405,1.311-7.405,16.03s0,40.72,0,45.47s5.515,5.515,5.515,5.515h6.39h6.39c0,0,5.515-0.765,5.515-5.515s0-30.75,0-45.47
	S17.905,38.109,17.905,38.109z"/>
</svg>
</div>
</div>
<div class="bar"></div>
<div class="text">Registering</div>
</div>
</body>

</html>