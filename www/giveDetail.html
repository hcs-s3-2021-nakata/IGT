<!DOCTYPE HTML>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta http-equiv="Content-Security-Policy" content="default-src * data: gap: content: https://ssl.gstatic.com; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'">
  <script src="components/loader.js"></script>
  <link rel="stylesheet" href="components/loader.css">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/modal.css">
  <link rel="stylesheet" href="css/deal.css">
  <link href="https://use.fontawesome.com/releases/v5.6.1/css/all.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script type="text/javascript" src="css/logout.js"></script>
  <script>
    // APIキーの設定とSDK初期化
    // API key.
    var applicationKey = "4d9d122337ca0de373857821e96b10ad1952a9133ffea44e66bcee94c282fccf";
    var clientKey = "00902e576a265322a217a2b2706056ca26048d4bd4f9096744fdd7e565d0f377";
    // SDK initialization.
    var ncmb = new NCMB(applicationKey, clientKey);
    var reader = new FileReader();

    // 画像を読み込む
    function setImage(){
      reader.onload = function(e) {
        var dataUrl = reader.result;
        document.getElementById("detail_image").src = dataUrl;
        document.getElementById("modal_image").src = dataUrl;
      }
    }

    // 画像を読み込む
    function downloadImage(fileName){  
      // ダウンロード（データ形式をblobを指定）
      ncmb.File.download(fileName, "blob")
           .then(function(blob) {
           // ファイルリーダーにデータを渡す
           reader.readAsDataURL(blob);
           })
           .catch(function(err) {
              console.error(err);
           })
    }

    // 取得した情報で画面を上書き
    function detailLoad(){
      var objectID = location.search.replace('?', '');
      var Give = ncmb.DataStore("give");
      Give.equalTo("objectId", objectID)
            .fetchAll()
            .then(function(results){
              var object = results[0];
              // 値の書き換え
              var category = changeCategory(object.category);
              var item_status = changeItemStatus(object.item_status);
              var delivery_time = changeDtime(object.delivery_time);
              var location = changeLocation(object.location);

              downloadImage(object.item_image);
              setImage(object.item_image);

              document.getElementById('item_name').innerHTML = object.item_name;
              document.getElementById('item_info').innerHTML = object.item_info.replace(/\n/g, '<br>');
              document.getElementById('category').innerHTML = category;
              document.getElementById('item_status').innerHTML = item_status;
              document.getElementById('delivery_date').innerHTML = object.delivery_start_date + "<br><span class='wave'>～</span><br>" + object.delivery_end_date;
              document.getElementById('delivery_time').innerHTML = delivery_time;
              document.getElementById('location').innerHTML = location;
              
              // モーダルの書き換え
              document.getElementById('m_item_name').innerHTML = object.item_name;
              // この辺に出品者の書き換えをあとで入れる
              document.getElementById('m_delivery_date').innerHTML = object.delivery_start_date + "<br><span class='wave'>～</span><br>" + object.delivery_end_date;
              document.getElementById('m_delivery_time').innerHTML = delivery_time;
              document.getElementById('m_location').innerHTML = location;

            })
            .catch(function(err){
                console.log(err);
            });
    }

    // カテゴリーを書き換える
    function changeCategory(category){
      switch (category){
            case '1':
              category = "おもちゃ・ゲーム";
              break;
            case '2':
              category = "本・テキスト";
              break;
            case '3':
              category = "音楽・ＤＶＤ";
              break;
            case '4':
              category = "服・コスメ";
              break;
            case '5':
              category = "キッチン";
              break;
            case '6':
              category = "スポーツ";
              break;
            case '7':
              category = "PC・スマホ用品";
              break;
            case '100':
              category = "その他";
              break;
            default:
              break;
          }
      return category;
    }

    // 商品状態を書き換える
    function changeItemStatus(item_status){
      switch (item_status){
            case '1':
              item_status = "新品";
              break;
            case '2':
              item_status = "ほぼ新品";
              break;
            case '3':
              item_status = "多少の傷あり";
              break;
            case '4':
              item_status = "傷・汚れあり";
              break;
            case '5':
              item_status = "状態が悪い";
              break;
            default:
              break;
          }
      return item_status;
    }

    // 受け渡し時間帯を書き換える
    function changeDtime(delivery_time){
      switch (delivery_time){
            case '1':
              delivery_time = "１コマ目終了後";
              break;
            case '2':
              delivery_time = "昼休み";
              break;
            case '3':
              delivery_time = "３コマ目終了後";
              break;
            case '4':
              delivery_time = "４コマ目終了後";
              break;
            default:
              break;
          }
      return delivery_time;
    }

    // 受け渡し場所を書き換える
    function changeLocation(location){
      switch (location){
            case '1':
              location = "本校舎3Fホール";
              break;
            case '2':
              location = "本校舎4Fホール";
              break;
            case '3':
              location = "本校舎5F";
              break;
            case '4':
              location = "本校舎6Fホール";
              break;
            case '5':
              location = "本校舎7F";
              break;
            case '6':
              location = "本校舎8F";
              break;
            case '7':
              location = "2号館入口";
              break;
            case '8':
              location = "3号館入口";
              break;
            case '9':
              location = "3号館ホール";
              break;
            case '100':
              location = "その他";
              break;
            default:
              break;
          }
      return location;
    }

    // 詳細画面のモーダル表示用スクリプト（仮）
    function modal_open() {
      const open = document.getElementById('d_open');
      const ok = document.getElementById('d_ok');
      const close = document.getElementById('d_cancel');
      const modal = document.getElementById('d_modal');
      const mask = document.getElementById('mask');

      open.addEventListener('click', () => {
        // 表示
        modal.classList.remove('hidden');
        mask.classList.remove('hidden');
      });

      ok.addEventListener('click', () => {
        var objectID = location.search.replace('?', '');
        console.log(objectID);
        localStorage.setItem("flag", "give");
        localStorage.setItem("objectID", objectID);
        localStorage.setItem("give_userID", "仮");
        localStorage.setItem("take_userID", "仮");
        document.location.href = 'qrGenerater.html?'+objectID;
      });

      close.addEventListener('click', () => {
        modal.classList.add('hidden');
        mask.classList.add('hidden');
      });

      mask.addEventListener('click', () => {
        close.click();
      });
    }
  </script>
</head>

<body id="prodact_lists" onload="detailLoad()">
  <!-- Header Start -->
  <header class="site-header">
    <div class="wrapper site-header__wrapper">
      <nav class="nav">
        <div class="detail_head">
          <div class="back_button">
            <a href="javascript:history.back()">
              <i class="fas fa-angle-left back_size"></i>
            </a>
          </div>
          <div class="page_title">
            <input class="hidden" type="checkbox" id="menu-btn-check"><span class="center">譲渡品詳細</span>
            <label for="menu-btn-check" class="menu-btn"><span></span></label>
            <div style="text-align: left" class="menu-content">
              <ul>
                <li><a href="acount.html">アカウント詳細</a></li>
                <li><a href="message.html">通知</a></li>
                <li><a href="dealHistory.html">取引履歴</a></li>
                <li><a href="myGiveItem.html">出品した譲渡品</a></li>
                <li><a href="myTradeItem.html">出品した交換品</a></li>
                <li><a onclick="logout_button()">ログアウト</a></li>
              </ul>
            </div>
          </div>
          <div class="header_right">
          </div>
        </div>
      </nav>
    </div>
  </header>
  <!-- Header End -->

  <!-- Body Start -->
  <div id="detail">
    <br>
    <div>
      <img src="" id="detail_image"/>
    </div>
    <br>
    <div class="container_detail_name" id="name_box">
      <a id="item_name">商品名</a>
    </div>
    <br>
    <a>譲渡品の説明</a>
    <div class="container_detail_info" id="info_box">
      <a id="item_info">商品説明</a>
    </div>
    <br>
    <a>譲渡品の情報</a>
    <table class="deal-detail_table">
      <tr>
        <th>カテゴリ</th>
        <td id="category">値</td>
      </tr>
      <tr>
        <th>商品の状態</th>
        <td id="item_status">値</td>
      </tr>
      <tr>
        <th>受け渡し期間</th>
        <td id="delivery_date">値</td>
      </tr>
      <tr>
        <th>受け渡し時間帯</th>
        <td id="delivery_time">値</td>
      </tr>
      <tr>
        <th>受け渡し場所</th>
        <td id="location">値</td>
      </tr>
    </table>
    <br>
    <button type="button" class="plz" id="d_open" onclick="modal_open()"> 欲しい！ </button>
    <div id="mask" class="hidden"></div>
    <div><br><br><br><br><br>
      <!-- Body End -->

      <!-- Footer Start -->
      <ul class="bottom-menu">
        <li>
          <a class="icon-blue" href="index.html">
            <i class="far fa-list-alt"></i></a>
        </li>
        <li>
          <a href="deal.html"><i class="fas fa-random"></i></a>
        </li>
        <li>
          <a href="insert.html"><i class="fas fa-plus"></i></a>
        </li>
        <li>
          <a href="qrreader.html"><i class="fas fa-qrcode"></i></a>
        </li>
        <li>
          <a href="voice.html">
            <i class="fas fa-bullhorn"></i></a>
        </li>
      </ul>
      <!-- Fotter End -->

      <!-- モーダルウィンドウ -->
      <section id="d_modal" class="hidden">
        <div class="modal_box">
          <a id="m_item_name">商品名</a>
          <br>
          <img src="" id="modal_image"/>
          <br>
          <table class="modal_table">
            <tr>
              <th class="modal_table">出品者</th>
              <td id="m_give_userID">値</td>
            </tr>
            <tr>
              <th class="modal_table">受け渡し期間</th>
              <td id="m_delivery_date">値</td>
            </tr>
            <tr>
              <th class="modal_table">受け渡し時間帯</th>
              <td id="m_delivery_time">値</td>
            </tr>
            <tr>
              <th class="modal_table">受け渡し場所</th>
              <td id="m_location">値</td>
            </tr>
          </table>
        </div>
        <br>
        <a>この取引を開始しますか？</a>
        <div id="d_button">
          <div id="d_cancel">
            閉じる
          </div>
          <div id="d_ok">
            進める
          </div>
        </div>
      </section>

</html>